
%  article.tex (Version 3.3, released 19 January 2008)
%  Article to demonstrate format for SPIE Proceedings
%  Special instructions are included in this file after the
%  symbol %>>>>
%  Numerous commands are commented out, but included to show how
%  to effect various options, e.g., to print page numbers, etc.
%  This LaTeX source file is composed for LaTeX2e.

%  The following commands have been added in the SPIE class 
%  file (spie.cls) and will not be understood in other classes:
%  \supit{}, \authorinfo{}, \skiplinehalf, \keywords{}
%  The bibliography style file is called spiebib.bst, 
%  which replaces the standard style unstr.bst.  

\documentclass[a4paper]{spie}  %>>> use for US letter paper
%%\documentclass[a4paper]{spie}  %>>> use this instead for A4 paper
%%\documentclass[nocompress]{spie}  %>>> to avoid compression of citations
%% \addtolength{\voffset}{9mm}   %>>> moves text field down
%% \renewcommand{\baselinestretch}{1.65}   %>>> 1.65 for double spacing, 1.25 for 1.5 spacing 
%  The following command loads a graphics package to include images 
%  in the document. It may be necessary to specify a DVI driver option,
%\textit{}%  e.g., [dvips], but that may be inappropriate for some LaTeX 

%  installations. 
\usepackage{amsmath}
\usepackage[]{graphicx}
\usepackage{hyperref}
\usepackage{listings}
\hypersetup{
    colorlinks,
    linkcolor={black!50!black},
    citecolor={blue!50!black},
    urlcolor={blue!80!black}
}
\usepackage{pdfpages}
\usepackage{parcolumns}

\usepackage[utf8]{inputenc} 
\usepackage[ngerman]{babel}
\usepackage[autostyle=true,german=quotes]{csquotes}

\usepackage{lipsum}
\usepackage{color}
\definecolor{lightgray}{rgb}{.9,.9,.9}
\definecolor{darkgray}{rgb}{.4,.4,.4}
\definecolor{purple}{rgb}{0.65, 0.12, 0.82}

\usepackage[titletoc,toc,title]{appendix}

\usepackage{array}
\newcolumntype{L}[1]{>{\raggedright\let\newline\\\arraybackslash\hspace{0pt}}m{#1}}
\newcolumntype{C}[1]{>{\centering\let\newline\\\arraybackslash\hspace{0pt}}m{#1}}
\newcolumntype{R}[1]{>{\raggedleft\let\newline\\\arraybackslash\hspace{0pt}}m{#1}}

\usepackage[export]{adjustbox}
\usepackage{xcolor,colortbl}
\usepackage{color}
\usepackage{float}
%\usepackage{sectsty}

\definecolor{lightgray}{rgb}{.9,.9,.9}
\definecolor{darkgray}{rgb}{.4,.4,.4}
\definecolor{purple}{rgb}{0.65, 0.12, 0.82}
% Farben definieren
\definecolor{codeGray}{RGB}{240,240,240}
\definecolor{codeBlack}{RGB}{0,0,0}
\definecolor{codeRed}{RGB}{221,0,0}
\definecolor{codeBlue}{rgb}{0,0,187}
\definecolor{codeYellow}{RGB}{255,128,0}
\definecolor{codeGreen}{RGB}{0,119,0}

% … und zuweisen
\lstdefinelanguage{JavaScript}{
  keywords={typeof, new, true, false, catch, function, return, null, catch, switch, var, if, in, while, do, else, case, break},
    basicstyle={\small\ttfamily\color{codeGreen}},%
    commentstyle={\color{codeYellow}},%
    keywordstyle={\color{codeBlue}},%
    stringstyle={\color{codeRed}},%
    identifierstyle={\color{codeBlue}},%
  sensitive=false,
  comment=[l]{//},
  morecomment=[s]{/*}{*/},
  commentstyle=\color{purple}\ttfamily,
  stringstyle=\color{red}\ttfamily,
  morestring=[b]',
  morestring=[b]"
}

\lstset{
   language=JavaScript,
   backgroundcolor=\color{lightgray},
   extendedchars=true,
   basicstyle=\footnotesize\ttfamily,
   showstringspaces=false,
   showspaces=false,
   numbers=left,
   numberstyle=\footnotesize,
   numbersep=9pt,
   tabsize=2,
   breaklines=true,
   showtabs=false,
   captionpos=b
}

\title{Mobiledevice Controller Framework} %% TODO: Chris, Hannes, Micha, Dennis, Ron

%>>>> The author is responsible for formatting the 
%  author list and their institutions.  Use  \skiplinehalf 
%  to separate author list from addresses and between each address.
%  The correspondence between each author and his/her address
%  can be indicated with a superscript in italics, 
%  which is easily obtained with \supit{}.

\author{ Ron Schiwkowksi  (918691), Hannes Grothknopf (915449), Michael Schleiss (923739)), Dennis Hofmann (919285), Christian Heinrichs (919020)
\skiplinehalf
University of Applied Sciences, Sokratesplatz 1, 24149 Kiel, Germany
}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% 
%>>>> uncomment following for page numbers
\pagestyle{plain}    
%>>>> uncomment following to start page numbering at 301 
%\setcounter{page}{301} 
 
  \begin{document} 
  \maketitle 
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% 
\begin{abstract} %% TODO: Micha
Lorem ipsum dolor sit amet, consetetur sadipscing elitr, sed diam nonumy eirmod tempor invidunt ut labore et dolore magna aliquyam erat, sed diam voluptua. At vero eos et accusam et justo duo dolores et ea rebum. Stet clita kasd gubergren, no sea takimata sanctus est Lorem ipsum dolor sit amet. Lorem ipsum dolor sit amet, consetetur sadipscing elitr, sed diam nonumy eirmod tempor invidunt ut labore et dolore magna aliquyam erat, sed diam voluptua. At vero eos et accusam et justo duo dolores et ea rebum. Stet clita kasd gubergren, no sea takimata sanctus est Lorem ipsum dolor sit amet.
\end{abstract}

%>>>> Include a list of keywords after the abstract 
\keywords{Mobile, Smartphone, JavaScript, HTML5, Nodejs, API}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{Einleitung} %% TODO: Hannes
Das vorliegende Dokument beschreibt die Entwicklung eines Frameworks, welches es erlaubt verschiedene Anwendungen im öffentlichen Raum zu installieren, die mit Hilfe von mobilen Controllern gesteuert werden können. Hierbei stehen zwei Aspekte im Vordergrund. Zum einen soll das Framework eine Schnittstelle bieten, eigene Anwendungen unkompliziert in eine stabile Infrastruktur einzubinden. Dies bedeutet, dass alle notwendigen Funktionen der Kommunikation und der Nutzerverwaltung durch das Framework abgedeckt sind und der Entwickler unabhängig davon sehr flexible verschiedenste Anwendungen realisieren kann. Zum anderen soll das Framework dem Endbenutzer die einfache Bedienung der Anwendung über persönliche mobile Geräte, wie Smartphones ermöglichen. Hierbei sollen möglichst alle Arten der Eingabe des Endgerätes genutzt und dieses so in ein multifunktionales Gamepad verwandelt werden.

\subsection{Problemstellung}

%\begin{figure}[H]
%	\begin{minipage}[t]{0.4\textwidth}
%		\vspace{0pt}
		\paragraph{Problemstellung}\mbox{}\\
Die Möglichkeit ein Spiel komfortabel mit einem mobilen Gerät zu verbinden und zu steuern soll im folgenden unseren Beschreibungen zugrunde liegen. Hierzu werden verschiedene Technologien miteinander verbunden und genutzt.\\
Eine Möglichkeit zu schaffen komfortabel an einem Spiel teilzunehmen, als Beispiel an einem Flughafen per QR-Code einem laufenden Spiel beizutreten, motivierte uns zu diesem Thema.
%	\end{minipage}
%	\hfill
%	\begin{minipage}[t]{0.5\textwidth}
%		\vspace{0pt}
%		\fbox{\includegraphics[width=8cm]{./images/FrontendInit.png}}
%		\caption{3D Cube}
%		\label{fig:test2}
%	\end{minipage}
%\end{figure}


\section{Methodik}
\subsection{Projektmanagement}
Das Team besteht aus 5 Projektmitgliedern. Die Verteilung der Aufgaben ist in Tabelle \ref{table:Aufgabenverteilung} aufgestellt.
Verschiedene Aufgaben sind im Gitlab erfasst und Personen zugewiesen. Ein wöchentliches persönliches Treffen aller Projektmitglieder führt zu einer guten Arbeitsmoral und hohen Effektivität.
\subsubsection{GitLab}
Das Projekt wurde auf einem eigenen GitLab gehostet und den Projektmitgliedern zur Verfügung gestellt. Die Issues des Systems wurden genutzt um Aufgaben zu verteilen und zu dokumentieren.
\\
Strukuriert wurde das Arbeiten nach Feature Branches, um das Arbeiten am Projekt möglichst flexibel zu halten. Der Master-Branch diente als Release-Branch, in den regelmäßig die Änderungen per Merge Request eingetragen und getestet wurden.
\definecolor{blau}{HTML}{217AA2}
\begin{table}
	\label{table:Aufgabenverteilung}
	\centering
		\caption{Matrix der Aufgabenverteilung}
		\begin{tabular}{| L{2.6cm} | C{2cm} | C{2cm} | C{2cm} | C{2cm} | C{2cm} |}
		\hline
		\rowcolor{blau}
		\textcolor{white}{\textbf{Aufgabe}} & \textcolor{white}{\textbf{Schleiss}} & \textcolor{white}{\textbf{Grothkopf}} & \textcolor{white}{\textbf{Schiwkowski}} & \textcolor{white}{\textbf{Hofmann}} & \textcolor{white}{\textbf{Heinrichs}}\\\hline
		Recherche 		& X & X	& X	& X	& X	\\\hline
		Konzept 		& X & X	& X	& X	& X	\\\hline
		Serverdesign	& 	& X & 	& 	& X \\\hline
		Networking		& 	& X	& 	& X	& X	\\\hline
		GameAPI 		& 	& X	&	&	& X	\\\hline
		DemoGame 		& X	&	&	&	& X	\\\hline
		ClientFrontend 	& X	&	& X	&	&	\\\hline
		ClientBackend 	& X	&	& X	&	&	\\\hline
		Userhandling 	& 	&	&	& X	& 	\\\hline
		Documentation   & X	& X & X	& X	& X \\\hline
		Projektmgmt. 	&	&	&	& 	& X	\\\hline
	\end{tabular}
\end{table}

\subsection{Technologien} %% TODO: Dennis
\begin{figure}[H]
\begin{minipage}[t]{0.4\textwidth}
\vspace{0pt}
\paragraph{NodeJS / Javascript}\mbox{}\\
NodeJS ist eine Laufzeitumgebung für JavaScript und basiert auf der Chrome's V8 JavaScript engine. 

\end{minipage}
\hfill
\begin{minipage}[t]{0.5\textwidth}
\vspace{0pt}
\paragraph{HTML 5}\mbox{}\\
In diesem Projekt setzen wir auf HTML5 um die Sensordaten der Geräte auszulesen. Dies ist durch das neue HTML5 einfach umzusetzen.
\end{minipage}
\end{figure}

\subsubsection{Javascript Bibliotheken}

\begin{figure}[H]
\begin{minipage}[t]{0.4\textwidth}
\vspace{0pt}
\paragraph{jQuery}\mbox{}\\
jQuery ist ein schnelle, umfangreiche und einfach zu bedienende JavaScript-Bibliothek. Sie ermöglicht Dinge wie das einfache modifizieren von HTML, Ereignisverarbeitung, Animation und Ajax.
\end{minipage}
\hfill
\begin{minipage}[t]{0.5\textwidth}
\vspace{0pt}
\paragraph{require.js}\mbox{}\\
RequireJS ist eine Bibliothek um einfach JavaScript-Dateien und Module zu laden. Es ist für den In-Browser-Einsatz optimiert, kann allerdings auch in anderen JavaScript-Umgebungen wie Rhino und Note verwendet werden.
\end{minipage}
\end{figure}


\begin{figure}[H]
\begin{minipage}[t]{0.4\textwidth}
\vspace{0pt}
\paragraph{socket.io}\mbox{}\\
Das Framework \enquote{socket.io} wird in Abschitt \ref{socketio} ausführlich beschrieben.
\end{minipage}
\hfill
\begin{minipage}[t]{0.5\textwidth}
\vspace{0pt}
\paragraph{MongoDB}\mbox{}\\
MongoDB ist eine Schema-freie, dokumentenorientierte Open-Source-Datenbank, die in der Programmiersprache C++ geschrieben ist. Da die Datenbank dokumentenorientiert ist, kann sie Sammlungen von JSON-ähnlichen Dokumenten verwalten. Dadurch lässt sie sich leicht mit JavaScript zusammen benutzen und wurde von uns gewählt.
\end{minipage}
\end{figure}


\subsubsection{Hardware}
Die Server Hardware kann je nach Bedarf eine Server- oder Desktopumgebung sein. Der NodeJS Server kann platformunabhängig auf so gut wie allen Platformen genutzt werden.\\
Als Eingabegerät sind Mobile Geräte wie Smartphones oder Tablets angedacht. Mit ihren Sensoren und Touchdisplays sind diese prädestiniert.
%
% -----------------Implementierung-------------------------
%

\section{Implementierung}


\subsection{Architektur}
\begin{figure}[H]
	\begin{minipage}[t]{0.4\textwidth}
		\vspace{0pt}
		\paragraph{Network}\mbox{}\\
		Die Netzwerkverbindungen bilden einen wichtigen Bestandteil der Anwendung. Alle Clients und das Server-Frontend bzw. Spiel verbinden sich zum Server via WebSocket.
	\end{minipage}
	\hfill
	\begin{minipage}[t]{0.5\textwidth}
		\vspace{0pt}
		\includegraphics[width=8.5cm]{images/arch/M113.png}
		\caption{Architektur der Applikation}
		\label{fig:test2}
	\end{minipage}
\end{figure}



\subsubsection{socket.io}\label{socketio}
Zum Aufbau und Handling der Netzwerkverbindungen wird die Bibliothek socket.io von Guillermo Rauch verwendet. Sie kapselt die WebSocket API Spezifikationen und bietet eine vereinfachte und einfach zu benutzende API zu den WebSockets auf Client und Server-Seite. Außerdem verfügt sie über Failover-Strategien, die das Verwenden von anderen Protokollen vorsehen, für den Fall, dass WebSockets vom Client oder Server nicht unterstützt werden.\\
Auf node Server Seite werden die Pakete 'http' und 'socket.io' benötigt. Erstes um einen HTTP-Server zu erstellen und letzteres, um diesen dann zu einer WebSocket Verbindung aufzuwerten und diese dann zu verwalten. Grundlegen wird die Verbindung mit Hilfe von message Events implementiert, welche auf dem jeweiligen Socket ausgelöst und abgehört werden können. Dieses Prinzip ähnelt stark den von node bekannten Events. Eine Client-Version von socket.io wird vom Server automatisch veröffentlich und kann so auf dem Client direkt eingebunden und
verwendet werden.\footnote{\url{https://davidwalsh.name/websocket} [3] [4]}


\subsubsection{Server Network Handling}
Die Anwendung besteht aus einem zentralen node Server, einem Frontend zur Darstellung des Spiels und eine unbestimmte Anzahl an mobilen Clients. Alle Komponenten stellen jeweils eine WebSocket Verbindung zum Server her, der diese so zentral verwalten kann. Durch die Implementation der selbst geschriebenen Module 'gameApi' und 'clientNetwork' werden die Funktionen der WebSockets erneut gekapselt und ermöglichen eine stark angepasste Verwendung.\\
Der Server hält zu jeder Zeit eine Liste aller offenen Socket-Verbindungen, was es ermöglich individuell mit jedem Client und dem Frontend zu kommunizieren und eingehende Nachrichten direkt einem Absender zuzuordnen. Auf diesem Level der Kommunikation wurden grundlegende Socket-Events zum Verbindungsaufbau, der Nutzerverwaltung sowie dem Verschicken der eigentlichen Nachrichten implementiert. Abhängig vom Typ der eingehenden Nachricht werden die Funktionen der nächst-höheren Programmschicht aufgerufen, die diese dem Netzwerk Modul bei der Initialisierung per Callback übergeben hat. Die eigentlichen Socket-Events werden an dieser Stelle nicht weitergegeben, um die technische Socket-Logik komplett im Modul zu kapseln. Die Struktur der einzelnen Nachrichtentypen wurde genau definiert. Besonders im Fall der tatsächlichen Nachtrichten Pakete wurde ein weiteres 'type' Attribut eingefügt, die es dem Spieleentwickler erlaubt unabhängig von den Socket Events eigene Nachrichten-Typen zu definieren. Ein weiterer wichtiger Aspekt ist die Art und Weise in der die Sockets auf Client-Seite aufgebaut werden.\\
Zusätzlich bietet das 'serverNetwork' Modul eine Reihe an Funktionen an, mit den Clients und dem Frontend zu kommunizieren und diese zu verwalten.\footnote{\url{http://stackoverflow.com/questions/7709289/how-to-pass-javascript-object-from-one-page-to-other} und \url{http://tavendo.com/blog/post/websocket-persistent-connections/}}


\subsection{Session}
Die nächste Schicht nach dem Netzwerk stellt auf Server-Seite das Modul 'sessionHandling' dar. Hier werden die noch anonymen Socket-Verbindungen bzw. deren IDs mit tatsächlichen Nutzernamen und der zugrundeliegenden Nutzerverwaltung verknüpft. Dies bedeutet zunächst, dass jeder Client sich zum Benutzen der Anwendung am Server authentifizieren muss. Jede eingehende Login-Anfrage wird an das Modul 'UserManagement' weitergeleitet um die übergebenden Nutzerdaten zu verifizieren. Nach einem erfolgreichen Login werden die Daten des Nutzers in eine Liste aktiver Nutzer gespeichert und sein Nutzername wird an die nächste Schicht weiter gegeben. Beim Disconnet eines Nutzers wird sein Eintrag aus der Liste gelöscht und es wird ebenfalls eine Nachricht an die nächste Programm-Schicht übergeben. Alle Nachrichten, die tatsächliche Kommunikationsdaten beinhalten werden direkt weitergegeben.\\
Ein Login bedeutet notwendigerweise eine zuvor erfolgte Registrierung, welche ebenfalls vom 'UserManagement' Modul verwaltet wird. Um die Registrierung jedoch nicht zu einer unnötigen Barriere in der Verwendung der Applikation zu machen, ist es ebenfalls möglich sich anonym einzuloggen. In diesem Fall wird der jeweiligen Socket-Verbindung ein zufälliger Nutzername zugewiesen. Der Vorteil eines Nutzerkontos bietet die Möglichkeit für das Spiel, Session übergreifend Daten für die Benutzer zu speichern.\\
Die Login-Sessions sind direkt an eine bestehende Socket-Verbindung gekoppelt und werden beendet, sobald der Socket geschlossen wird.
\subsection{User Management}
Das \enquote{UserManagement} kümmert sich um die Verwaltung der Nutzer. Dafür stellt es Funktionen für die Registrierung, Authentifizierung sowie für das setzen und holen von Benutzerdaten zur Verfügung. Die Funktionen im \enquote{UserManagement} bekommen eine callback Funktion übergeben, welche bei einer erfolgreichen Ausführung ausgeführt wird.

\subsection{Datenbank}
Das "Database" Modul kümmert sich um die Persistente Speicherung aller anfallenden Daten. Dafür wird eine MongoDB verwendete und die für das hinzufügen, löschen, updaten und für Abfragen benötigten Funktionen zur Verfügung gestellt.

\subsection{Mobile - Sensoren und Daten}
Die Basis aller weiteren Schritte ist das Auslesen der Sensordaten eines geeigneten Gerätes, während der gesamten Entwicklung wurden hierfür Smartphones unterschiedlicher Hersteller und Generationen verwenden. Die Daten wurden auf dem Gerät gemessen, aufbereitet und als gekapselte Datenpakete an den vorgesehenen Empfänger gesandt. Die Datenaufbereitung ist ein wichtiger Schritt, um die Netzwerklast am Knotenpunkt, dem Server, möglichst gering zu halten, da mehrere Geräte gleichzeitig eine Verbindung herstellen und aufrecht erhalten können und dies zu einer Überlast des Empfängers bei unkontrolliertem Sendevolumen führt.\\
Die von der Applikation genutzten Daten sind im folgenden erläutert.
\paragraph{Touchbildschirm}
Die übliche Art der Interaktion mit einem aktuellen Smartphone, die Toucheingabe, darf natürlich nicht außer Acht gelassen werden. Da diese in der Entwicklung äußerst einfach zu implementieren ist, unteranderem über JQuerys .tap(), kann diese Eingabe als trivial angesehen und hier nicht weiter darauf eingegangen werden.

%\begin{figure}[H]
%	\begin{minipage}[t]{0.4\textwidth}
%		\vspace{0pt}
		\paragraph{Rotations- und Beschleunigungssensor}\mbox{}\\
Diese Werte bilden den Kern der Applikation und sollen hier näher dargestellt werden:\\
Die Interaktion über die Bewegung des Smartphones im dreidimensionalen Raum ist intuitiv und gut für jede denkbare Aufgabe geeignet. Die Datenerhebung erfolgt dabei für gewöhnlich durch Differentialkondensatoren und Drei-Achsen-Gyroskope.
Da die Daten vom Gerät kontinuierlich in festgelegten Intervallen bestimmt werden, können diese auf komfortable Art und Weise ausgelesen werden. Die aufwändigere Arbeit ist die anschließende Verarbeitung und Filterung der Daten. Dies geschieht über ein zu setzendes Event, namentlich das \enquote{devicemotion} -Event, das bei jeder Änderung der Rotation oder Beschleunigung feuert und seine Daten beispielhaft in der Form event.acceleration.x; oder event.accelerationRate.alpha; bereitstellt, ebenso wie das Intervall der gemessenen Daten (in Millisekunden) über event.interval; verwendet werden kann. Siehe auch Anhang \ref{rotation}.\\
%	\end{minipage}
%	\hfill
%	\begin{minipage}[t]{0.5\textwidth}
%		\vspace{0pt}
%		\fbox{\includegraphics[width=8cm]{./images/rotation}}
%		\caption{Rotationsachen dargestellt}
%		\label{fig:test2}
%	\end{minipage}
%\end{figure}
Die Originalversion der Rotation und Berechnungen sind zu finden in den Aufzeichnungen von Damian Gordon\footnote{\url{http://de.slideshare.net/DamianGordon1/3d-robot-movements}}.\\
Die Aufbereitung der Daten geschieht über eine Filterung aller leeren und ungültigen Daten, außerdem aller Daten, die darauf schließen lassen, dass keine Bewegung stattfand. Um eine Überlast der Datenverbindung zu verhindern wird eine Mittelung der ausgelesenen Daten als adäquates Mittel angesehen, diese kann über eine festgelegte Anzahl der Werte vorgenommen werden. Da Smartphones allerdings in einem unterschiedlichen Intervall Daten Messen, in der Entwicklung wurde eine Messung im Abstand von 50ms, 100ms und 200ms festgestellt, kann die Mittelung auch über einen gewissen Zeitwert vorgenommen werden.

\paragraph{Ausrichtung des Gerätes}
Die Orientierung des Gerätes wird als „Portrait“ oder „Landscape“, also vertikale oder horizontale Ausrichtung beschrieben. Diese Daten verwenden dieselbe Technik wie der Beschleunigungssensor und wird beispielsweise in der Bildschirmausrichtung verwendet. So einfach wie das Prinzip ist auch die Verwendung: Die Ausrichtung lässt sich über window.orientation; (in Grad) ausmessen. Ein Wert über 180 beschreibt dabei den Portraitmodus, über 180 den Landscape- oder Landschaftsmodus.

\vspace{0pt}
\paragraph{Bild und Tonaufzeichungen}\mbox{}\\
Da dies einer der komplexeren Datentypen ist, den man mit dem Handy aufzeichnen kann, empfiehlt sich für die Aufnahme eine leicht benutzbare API. Mit getUserMedia() ist für Bild und Ton nun eine einfache Alternative verfügbar, die Stückweise in die aktuelle Browsergeneration eingefügt wird. Die aktuelle Verfügbarkeit innerhalb der Browser kann auf caniuse.com eingesehen werden und ergibt das Bild wie in Anhang \ref{app:caniuseMedia} aufgeziegt.

%\begin{figure}[H]
%\begin{minipage}[t]{0.4\textwidth}
%\vspace{0pt}
%\paragraph{Batteriestatus}\mbox{}\\
%Eine weitere Datenquelle ist der aktuelle Ladestatus (aktiv/inaktiv), die Batterieladung in Prozent und die Zeit zu vollständigen Ladung oder %Entladung. Dies wird realisiert über die Battery Status API, die aktuell eine ähnliche Browserabdeckung erreicht wie die getUserMedia()-API.\\
%Die Verarbeitung der Daten geschieht hier wie in der Rotations- und Beschleunigungsmessung über EventListener, die jeweils auf die Events %chargingchange, levelchange, chargingtimechange und dischargingtimechange reagieren und nach dem Schema battery.level; die gesuchten Daten %ausgeben.

%\end{minipage}
%\hfill
%\begin{minipage}[t]{0.5\textwidth}
%\vspace{0pt}
%    \includegraphics[width=8.5cm]{images/caniuseBatteryStatusAPI}
%     \caption{Unterstützung der Battery Status API auf caniuse.com}
%		\label{fig:test2}
%\end{minipage}
%\end{figure}

\paragraph{Vibration}
Im Gegensatz zu den anderen Daten geht es hierbei nicht um eine Ein-, sondern um eine Ausgabemethode. Die Benachrichtigung über Vibrationen ist in JavaScript denkbar einfach gestaltet, ist aber, ebenso wie die vorherigen APIs, nicht in jedem Browser verfügbar. Der letztliche Aufruf der Funktion geschieht über den Navigator, explizit über window.navigator.vibrate(), wobei die Länge und Art der Vibration angegeben werden kann.

\paragraph{Browserempfehlung}
Da (noch) nicht alle Browser alle APIs unterstützen, soll hier eine Empfehlung zur Verwendung der oben genannten Funktionalitäten genannt werden. Sowohl auf dem Desktop-Rechner als auch unter Android ist derzeit die aktuelle Version von Firefox (43) am 15.12.2015 erschienen und in der Lage, alle genannten Funktionen und APIs auszuführen.

\subsection{Graphical User Interface and JavaScript} %% TODO: Ron

Den Kern der grafischen Oberfläche bilden zwei Pfeile, die nach dem Prinzip eines Steuerkreuzes funktionieren und dazu genutzt werden, die Geschehnisse auf dem verbundenen Rechner zu kontrollieren. Die Benutzeroberfläche wurde absichtlich übersichtlich und simpel gehalten, um eine schnelle Akzeptanz zu gewährleisten. Aus Test- und Präsentationsgründen wurde in jeder Ecke des Templates eine Checkbox platziert, die jeweils eine Art von Sensordaten steuert. Speziell die gezielte Deaktivierung und Aktivierung der Audio- und Videodaten wurde als wichtiges Kriterium angesehen, da dies einen gefährlichen Eingriff in die Privatsphäre darstellen kann. Aus diesem Grund ist eine Aktivierung der genannten Multimediadaten nicht ohne vorherige Bestätigung möglich. \\
Jeder Tastendruck wird vom dahinterliegenden JavaScript aufgefangen und direkt an den Rechner weitergeleitet, wo er entsprechende Aktionen auslöst. Um den Benutzer in der Bedienung Sicherheit zu geben, wird für jeden Tastendruck ein optisches Feedback gegeben, entweder durch direkte Aktionen auf dem Rechner oder als Hinweis auf dem Smartphone selbst.
\subsection{Nutzen der GameAPI}
Der Entwickler kopiert das in Anhang \ref{lst:CodeSnippetGameApi} kommentierte Code-Skelett in sein Spiel und füllt die gekennzeichneten Stellen mit seiner Spielsteuerung.


\section{Demonstration}
\subsection{Vorbereitung}
Ein Computer stellt den NodeJS Server.\\
Ein weiterer Computer stellt das gewählte Demogame-Frontend auf einem großen Bildschirm dar.\\
Mehrere Clients verbinden sich mit ihren mobilen Geräten auf den Server.\\
Anschließend müssen die vom NodeJS Server benötigten Abhängigkeiten installiert werden. Dies geschieht mit einen Aufruf des Skriptes \enquote{prepareDeps.sh}.
\lstset{
  numbers=left,
  stepnumber=5,
  firstnumber=1,
  numberfirstline=true
}

\subsection{Start der Applikation}
Der NodeJS Server wird mit dem Befehl wie in Listing \ref{lst:launchSuccess} gestartet. Imfolgenden sollte eine Meldung erscheinen welche den Applikationsserver als gestartet meldet. Eine Beispielhafte Meldung in in Listing \ref{lst:launchSuccess} zu sehen.

\begin{figure}[h!]
	\centering
        \begin{lstlisting}[language=JavaScript,caption={Start der Applikation},label={lst:launchSuccess}]
            node NodeServer/bin/www
            16 Jan 14:39:22 serverNetwork | Server listening on port 5222
        \end{lstlisting}
\end{figure}
\subsection{Nutzen einer Demo Applikation}

\begin{figure}[H]
\begin{minipage}[t]{0.4\textwidth}
\vspace{0pt}
\paragraph{Controller Interface}\mbox{}\\
Die Clients rufen die Adresse des Servers auf und es wird ihnen eine Login Anzeige dargestellt. Hier wird nun eine Entscheidung getroffen, ob ein Login erstellt, genutzt oder anonym weiter fortgefahren werden soll.
Wird ein Login genutzt, wird anstelle eines generierten Namens der tatsächliche Benutzername im gewählten Demogame angezeigt.

\end{minipage}
\hfill
\begin{minipage}[t]{0.5\textwidth}
\vspace{0pt}
    \includegraphics[width=8cm]{images/controllerLayoutModern}
     \caption{Unterstützung der getUserMedia API auf caniuse.com}
		\label{fig:test2}
\end{minipage}
\end{figure}



\begin{figure}[H]
\begin{minipage}[t]{0.4\textwidth}
\vspace{0pt}
\paragraph{Demo Applikation}\mbox{}\\
Auf einem Browser, welcher als Frontend dient, muss nun das entsprechende Game über die URL aufgerufen werden. In der Demo-Applikation ist dies \enquote{/game/ 1|2|3 /}
Die nun verbundenen Clients führen mit ihren Geräten unterschiedliche Aktionen durch. Ein Druck auf einen der Buttons auf einem der Clientgeräte wird als solcher identifiziert und im Frontend dargestellt. Ein anderer Client aktiviert die Rotationserfassung und die gesendeten Daten erscheinen auf dem Fronend.

\end{minipage}
\hfill
\begin{minipage}[t]{0.5\textwidth}
\vspace{0pt}
    \includegraphics[width=8cm]{images/demoGames}
     \caption{Unterstützung der getUserMedia API auf caniuse.com}
		\label{fig:test2}
\end{minipage}
\end{figure}

\section{Lasttestmessung}\label{Lasttestmessung} %% TODO: Dennis

\subsection{Server}

\paragraph{Szenario} 
Der Server wird nach und nach mit immer mehr Paketen belastet und die CPU-Auslastung ermittelt.


\paragraph{Durchführung}\mbox{}\\
Mithilfe des node-inspectors\footnote{https://github.com/node-inspector/node-inspector} wurde die NodeJS-Serveranwendung analysiert. Der node-inspector ermöglicht eine Nutzung der Entwicklertools des Chrom-Browsers. Zur Ermittlung der CPU-Last wurden Profile bei verschiedenen Lastzuständen erstellt welche 30 Sekunden lang aufrecht erhalten wurden. Das Testsystem war dabei mit einem Intel(R) Xeon(R) CPU E3-1241 v3 @ 3.50GHz ausgestattet.

\begin{minipage}[t]{0.4\textwidth}
	\vspace{0pt}
	\paragraph{Ergebnisse}\mbox{}\\
	Anhand der Ergebnisse ist gut der lineare Anstieg der Auslastung zu erkennen. Das Diagramm \ref{fig:ServerLast2} stellt die Ergebnisse von 0 bis 5500 Paketen da. Auf dem Diagramm \ref{fig:ServerLast2} ist gut zu erkennen das die Auslastung ab circa 3500 Paketen in einem geringerem maße ansteigt, allerdings ist auch hier ein linearer Verlauf zu erkennen. Die Auslastung schwankt zwar je nach eingesetzten System, der lineare Anstieg wird sich übertragen lassen. Um dies zu bestätigen sind weitere Messungen auf verschiedenen Testsystemen nötig.
\end{minipage}
\hfill
\begin{minipage}[t]{0.5\textwidth}
	\begin{figure}[H]	
	\vspace{0pt}
		\centering
		\includegraphics[width=1\textwidth]{./images/ServerLast3.png}
		\caption{Serverlast bei 0 - 5500 Paketen}
		\label{fig:ServerLast2}
	\end{figure}		
\end{minipage}


\subsubsection{Frontend}

\paragraph{Test Szenario} Zur Messung der Latenz wird ein Gerät mit dem Server verbunden und jede Sekunde dessen durchschnittliche Latenz vom Senden der Daten auf dem Gerät bis zur Ausgabe dieser durch die API erfasst. Die Auslastung des Servers wird durch das Senden von zusätzlichen Paketen erreicht. Die Senderate wird nach und nach gesteigert um die Maximale Auslastung der API auf dem Testsystem zu ermitteln. Zu beachten ist das auf allen Geräten vergleichbare Zeitstempel vergeben werden um die Ergebnisse nicht zu verfälschen. Die Test werden dabei ohne die Anbindung einer Anwendung an die API durchgeführt. Zu beachten ist, das diese auch Leistung benötigt was die Ergebnisse drastisch verändern kann. Aufgrund des Fokus auf die Entwicklung einer API ohne eine gezielte Anwendung wurde diese nicht berücksichtigt.


\paragraph{Durchführung}
Zur Erfassung der Daten wurde die Anzahl der gesendeten Pakete und der durchschnittlichen Latenz pro Sekunde von einem Gerät ermittelt. Während der Messung wurde der Server mit einer Unterschiedlich starken Anzahl an zusätzliche Paketen belastet um eine Höhere Auslastung zu erreichen. Die Werte wurden dabei in einem Abstand von einer Sekunde ermittelt. Zum Erfassen er Daten wurden die Chrome-Entwicklertools verwendet. Es wurden für jede Laststufe Daten über 50 Sekunden erfasst. Der Server und das Frontend liefen bei dem Test auf dem gleichen System.



\begin{minipage}[t]{0.4\textwidth}
\vspace{0pt}

\paragraph{Ergebnisse}\mbox{}\\
Die Ergebnisse der Messung sind in dem Diagramm \ref{fig:LatenzMessung} zu erkennen. Der Mittelwert gibt die Durchschnittliche Latenz über 50 Sekunden an. Durch die mittlere Abweichung ist gut zu erkennen das es zu gelegentlichen Latenz Spitzen kommt, welche im Betrieb unter Umständen zu Problemen führen können. Ab einer Paketanzahl von 5000 ist ein drastischer Anstieg der durchschnittlichen Latenz zu erkennen. Das für die Tests verwendetet Gerät hat eine durchschnittliche sende Rate von 100 Paketen die Sekunde, was auf dem Testsystem zu einer angenommenen Maximalen Anzahl von 50 Geräten führt. Mit blick auf die Daten von der Server-Leistungsmessung\ref{fig:ServerLast2} sollte die Anzahl von 35 Geräten nicht überschritten werden und der Bereich von 35-50 als Pufferzone eingeplant werden.
\end{minipage}
\hfill
\begin{minipage}[t]{0.5\textwidth}
	\begin{figure}[H]
	\vspace{0pt}
		\centering
		\centering
		\includegraphics[width=1\textwidth]{./images/LatenzMessung.png}
		\caption{Geräte Latenz Messung}
		\label{fig:LatenzMessung}
	\end{figure}	
\end{minipage}



%%
%%
%%
\section{Ausblick}

\paragraph{Glättung der Sensor Werte}
Ein noch zu lösendes Problem ist die Glättung der von den Sensoren kommenden Werte. Je nach Gerät liefern die Sensoren unterschiedlich stark schwankenden Daten. So sendet ein auf dem Tisch liegendes Gerät permanent Orientierungsdaten, obwohl es nicht bewegt wird. Diese Schwankungen müssen erkannt und unterbunden werden. Dies kann durch das einbauen eines thresholds für die Sensordaten erreicht werden.

\paragraph{Begrenzung der gesendeten Sensor Daten}
Um den Server nicht ungleich durch die verschiedenen Geräte zu belasten und die Auslastung berechenbar zu machen, muss das Sendeverhalten reglementiert werden. Die optimalen Werte dafür müssen noch durch weitere Leistungstest ermittelt werden und hängen auch von der Anwendung ab welche an die API angebunden ist.

\section{Fazit}
Die Umsetzung zeigt ein flexibles und belastbares Framework, welches es ermöglicht ein Spiel unkompliziert mit einem mobilen Gerät zu bedienen.
Ein Spieleentwickler hat die Möglichkeit eigene Controller-Templates bereitzustellen und mühelos sein Spiel zu integrieren.
Dazu nutzt er den Beispielcode und bedient sich der Eingabeevents des Frameworks, welche generiert werden. Das Usermanagement ermöglicht zudem eine komfortable Individualisierung der Spieler.




%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%% References %%%%%

\bibliographystyle{spiebib}   %>>>> makes bibtex use spiebib.bst


\appendix
\begin{appendices}
  \renewcommand\thetable{\thesection\arabic{table}}
  \renewcommand\thefigure{\thesection\arabic{figure}}
\section{}
\begin{figure}[H]\label{lst:CodeSnippetGameApi}
	\centering
        \begin{lstlisting}[language=JavaScript,caption={Nutzen der GampApi}]
    /** gameApi.controllerTemplates.*
    * Hier traegt der Entwickler ein, welches Gamepad-Controller Layout
    * auf dem Smartphone des Spielers angezeigt werden soll
    * */
    gameApi.controller = gameApi.controllerTemplates.MODERN;
    /**
     * HANDSHAKE - bitte nicht modifizieren
     * */
    gameApi.frontendConnection = function (connInfoObj) {
        gameApi.addLogMessage(gameApi.log.INFO, 'conn', connInfoObj + " " + gameApi.socket.id);
        this.emit('frontendOutboundMessage', {type: 'setControllerTemplate', data: gameApi.controller});
    };

    /**
     * Handling der eingehenden Daten
     * Hier wird die Steuerung des Spiels mit den Steuerungsdaten vom Smartphone kombiniert
     * */
    gameApi.frontendInboundMessage = function (data) {
        var controllerEvent = controllerData.data.message;
        var clientName = data.data.clientName;
        var message = data.data.message;

        switch (data.type) {
            // Ein Client betritt oder verlaesst das Spiel
            case "userConnection":
                gameApi.addLogMessage(gameApi.log.INFO, 'client', 'Client ' + clientName + ' ' + message);

                if (message === 'connected') {
                    // Was soll passieren wenn sich ein Client ins Spiel einloggt
                } else if (message === 'disconnected') {
                    // Was soll passieren, wenn sich ein Client das Spiel verlaesst
                }
                break;
            // Ein Client sendet ein Button Event
            case "button":
                if (controllerEvent.buttonName == 'btn-left' && controllerEvent.buttonState === gameApi.BUTTON.DOWN) {
                    // Was soll passieren, wenn Button A gedrueckt wird
                } else if (controllerEvent.buttonName == 'btn-right' && controllerEvent.buttonState === gameApi.BUTTON.DOWN) {
                    // Was soll passieren, wenn Button B gedrueckt wird
                }
                break;
            case "accelerationData":
                //Was passiert mit den Beschleunigungsdaten?
                break;
            case "orientationData":
                //Was passiert mit den Rotationsdaten?
                break;
            default:
                break;
        }
        \end{lstlisting}
\end{figure}
\section{}

\begin{figure}[H]
	\centering
	\includegraphics[width=1\textwidth]{images/FrontendInit}
	\caption{3D-Cube}
	\label{3dcube}
\end{figure}

\section{}
\begin{figure}[H]
	\centering
	\includegraphics[width=1\textwidth]{images/arch/M113.png}
	\caption{m113}
	\label{m113}
\end{figure}

  \section{}

	\begin{figure}[H]
		\includegraphics{images/caniuseGetUserMedia}
		\caption{Rotationsachen dargestellt}
		\label{app:caniuseMedia}
	\end{figure}


\section{}
\begin{figure}[H]
	\centering
	\includegraphics[width=1\textwidth]{images/rotation}
	\caption{Rotationsachen dargestellt}
	\label{rotation}
\end{figure}

\section{}
\begin{figure}[H]
	\centering
	\includegraphics[width=1\textwidth]{images/ServerLast1.png}
	\caption{ServerLast 0 - 10 Pakete}
	\label{serverlast1}
\end{figure}

\section{}
\begin{figure}[H]
	\centering
	\includegraphics[width=1\textwidth]{images/ServerLast2.png}
	\caption{ServerLast 10 - 100 Pakete}
	\label{serverlast1-2}
\end{figure}


\section{}
\begin{figure}[H]
	\centering
	\includegraphics[width=1\textwidth]{images/ServerLast3.png}
	\caption{ServerLast 0 - 55000 Pakete}
	\label{serverlast2}
\end{figure}

\section{}
\begin{figure}[H]
	\centering
	\includegraphics[width=1\textwidth]{images/LatenzMessung.png}
	\caption{Latenzmessung}
	\label{latenzmessung}
\end{figure}
\end{appendices}
%% Appendixs





\end{document} 
